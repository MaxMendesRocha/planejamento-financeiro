<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Planejamento Financeiro</title>
    <link rel="stylesheet" href="/css/style.css?v=<%= Date.now() %>">
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>
<body>
    <%- include('partials/navbar', { userName, active: 'dashboard' }) %>
    
    <div class="container">
        <div class="page-header">
            <h1><i data-feather="trending-up"></i>Dashboard Financeiro</h1>
            <p class="subtitle">Visão geral do seu planejamento</p>
        </div>
        
        <!-- Cards de Resumo -->
        <div class="dashboard-cards">
            <div class="stat-card">
                <div class="stat-icon"><i data-feather="dollar-sign"></i></div>
                <div class="stat-content">
                    <p class="stat-label">Renda Total</p>
                    <h2 class="stat-value">R$ <%= totalRendas.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></h2>
                </div>
            </div>
            
            <div class="stat-card necessidades">
                <div class="stat-icon"><i data-feather="shield"></i></div>
                <div class="stat-content">
                    <p class="stat-label">Necessidades (<%= config.percentual_necessidades %>%)</p>
                    <h2 class="stat-value">R$ <%= necessidades.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></h2>
                    <p class="stat-small">Gasto: R$ <%= despesas.necessidades.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
                </div>
            </div>
            
            <div class="stat-card desejos">
                <div class="stat-icon"><i data-feather="gift"></i></div>
                <div class="stat-content">
                    <p class="stat-label">Desejos (<%= config.percentual_desejos %>%)</p>
                    <h2 class="stat-value">R$ <%= desejos.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></h2>
                    <p class="stat-small">Gasto: R$ <%= despesas.desejos.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
                </div>
            </div>
            
            <div class="stat-card poupanca">
                <div class="stat-icon"><i data-feather="target"></i></div>
                <div class="stat-content">
                    <p class="stat-label">Poupança (<%= config.percentual_poupanca %>%)</p>
                    <h2 class="stat-value">R$ <%= poupanca.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></h2>
                    <p class="stat-small">Guardado: R$ <%= despesas.poupanca.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
                </div>
            </div>
        </div>
        
        <!-- Progresso das Metas -->
        <div class="card">
            <div class="card-header">
                <h2><i data-feather="alert-circle"></i>Reserva de Emergência (Dinâmica)</h2>
                <p style="color: var(--muted-foreground); font-size: 0.9rem; margin-top: 0.5rem;">
                    Baseada em 6 meses de suas despesas médias mensais
                </p>
            </div>
            <div class="meta-progress">
                <% if (despesaMediaMensal > 0) { %>
                    <div class="meta-info">
                        <p><strong>Despesa Média Mensal:</strong> R$ <%= despesaMediaMensal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
                        <p><strong>Meta (6 meses):</strong> R$ <%= (metaReserva.valor_meta || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
                        <p><strong>Guardado em Poupança:</strong> R$ <%= (metaReserva.valor_atual || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
                        <% const faltaGuardar = Math.max(0, (metaReserva.valor_meta || 0) - (metaReserva.valor_atual || 0)); %>
                        <p><strong>Falta Guardar:</strong> R$ <%= faltaGuardar.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <% const progressoMeta = metaReserva.valor_meta > 0 ? ((metaReserva.valor_atual || 0) / metaReserva.valor_meta * 100) : 0; %>
                            <div class="progress-fill" style="width: <%= Math.min(progressoMeta, 100).toFixed(1) %>%;"></div>
                        </div>
                        <div class="progress-percentage"><%= Math.min(progressoMeta, 100).toFixed(1) %>%</div>
                    </div>
                    <% if (progressoMeta >= 100) { %>
                        <div class="alert alert-success" style="margin-top: 1rem;">
                            ✅ Parabéns! Você atingiu sua meta de reserva de emergência!
                        </div>
                    <% } %>
                <% } else { %>
                    <div class="alert alert-info">
                        ℹ️ Comece a cadastrar suas despesas mensais para calcular automaticamente sua reserva de emergência ideal.
                    </div>
                    <p style="margin-top: 1rem; color: var(--muted-foreground);">
                        A reserva será calculada como <strong>6 meses</strong> de suas despesas médias mensais (necessidades + desejos).
                    </p>
                <% } %>
            </div>
        </div>
        
        <!-- Gráficos de Despesas -->
        <div class="grid-2">
            <div class="card">
                <div class="card-header">
                    <h2><i data-feather="bar-chart-2"></i>Orçamento vs Realizado</h2>
                </div>
                <div class="comparison-bars-vertical">
                    <% 
                        // Encontrar o maior valor entre TODOS os orçamentos e realizados
                        const maxValor = Math.max(
                            necessidades, desejos, poupanca,
                            despesas.necessidades, despesas.desejos, despesas.poupanca
                        );
                    %>
                    <!-- Necessidades -->
                    <div class="bar-group-vertical">
                        <label>Necessidades</label>
                        <div class="bars-container">
                            <div class="bar-wrapper">
                                <div class="bar-vertical-dynamic necessidades-bg" style="height: <%= maxValor > 0 ? ((necessidades / maxValor) * 100) : 0 %>%;">
                                    <span class="bar-value">R$ <%= necessidades.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                </div>
                                <div class="bar-label">Orçamento</div>
                            </div>
                            <div class="bar-wrapper">
                                <div class="bar-vertical-dynamic necessidades-bg-light" style="height: <%= maxValor > 0 ? ((despesas.necessidades / maxValor) * 100) : 0 %>%;">
                                    <span class="bar-value">R$ <%= despesas.necessidades.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                </div>
                                <div class="bar-label">Realizado</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Desejos -->
                    <div class="bar-group-vertical">
                        <label>Desejos</label>
                        <div class="bars-container">
                            <div class="bar-wrapper">
                                <div class="bar-vertical-dynamic desejos-bg" style="height: <%= maxValor > 0 ? ((desejos / maxValor) * 100) : 0 %>%;">
                                    <span class="bar-value">R$ <%= desejos.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                </div>
                                <div class="bar-label">Orçamento</div>
                            </div>
                            <div class="bar-wrapper">
                                <div class="bar-vertical-dynamic desejos-bg-light" style="height: <%= maxValor > 0 ? ((despesas.desejos / maxValor) * 100) : 0 %>%;">
                                    <span class="bar-value">R$ <%= despesas.desejos.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                </div>
                                <div class="bar-label">Realizado</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Poupança -->
                    <div class="bar-group-vertical">
                        <label>Poupança</label>
                        <div class="bars-container">
                            <div class="bar-wrapper">
                                <div class="bar-vertical-dynamic poupanca-bg" style="height: <%= maxValor > 0 ? ((poupanca / maxValor) * 100) : 0 %>%;">
                                    <span class="bar-value">R$ <%= poupanca.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                </div>
                                <div class="bar-label">Orçamento</div>
                            </div>
                            <div class="bar-wrapper">
                                <div class="bar-vertical-dynamic poupanca-bg-light" style="height: <%= maxValor > 0 ? ((despesas.poupanca / maxValor) * 100) : 0 %>%;">
                                    <span class="bar-value">R$ <%= despesas.poupanca.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></span>
                                </div>
                                <div class="bar-label">Realizado</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2><i data-feather="zap"></i>Ações Rápidas</h2>
                </div>
                <div class="quick-actions">
                    <a href="/despesas" class="action-button">
                        <span class="action-icon"><i data-feather="credit-card"></i></span>
                        <span>Adicionar Despesa</span>
                    </a>
                    <a href="/rendas" class="action-button">
                        <span class="action-icon"><i data-feather="dollar-sign"></i></span>
                        <span>Gerenciar Rendas</span>
                    </a>
                    <a href="/metas" class="action-button">
                        <span class="action-icon"><i data-feather="target"></i></span>
                        <span>Ver Metas</span>
                    </a>
                    <a href="/configuracoes" class="action-button">
                        <span class="action-icon"><i data-feather="settings"></i></span>
                        <span>Configurações</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <script>
        feather.replace();
    </script>
</body>
</html>
